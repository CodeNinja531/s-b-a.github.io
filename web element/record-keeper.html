<!DOCTYPE html>
<html lang="en">
<head>
    <!--Page setup-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House Points</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jwt-decode/3.1.2/jwt-decode.min.js"></script>
    <script src="script.js"></script>
</head>
<body>
    <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
    <button class="home-btn" onclick="location.href='home.html'">Home</button>
    <div id="menu-container"></div>
    <div class="auth"><div class="auth-button"></div></div>
    <!--------------------------------------------->

    <main>
        <h1>Record Keeper Tools</h1>
        <div>
            <div>
                <label for="type">Type:</label>
                <select id="type" name="type">
                    <option value="" selected>--</option>
                    <option value="racing">Racing</option>
                    <option value="field">Field</option>
                    <option value="relay">Relay</option>
                </select>
            </div>
            <br>
            <div style="display: flex; gap: 20px;">
                <div>
                    <label for="grade">Grade:</label>
                    <select id="grade" name="grade">
                        <option value="" selected>--</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </select>
                </div>

                <div>
                    <label for="gender">Gender:</label>
                    <select id="gender" name="gender">
                        <option value="" selected>--</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>

                <div>
                    <label for="items">Items:</label>
                    <select id="items" name="items">
                        <option value="" selected>--</option>
                    </select>
                </div>
            </div>

            <div id="track" style="margin-top:10px; display:none">
                <label for="track">Track No.:</label>
                <select id="track" name="track">
                    <option value="" selected>--</option>
                    <option value="1">Track 1</option>
                    <option value="2">Track 2</option>
                    <option value="3">Track 3</option>
                    <option value="4">Track 4</option>
                    <option value="5">Track 5</option>
                    <option value="6">Track 6</option>
                    <option value="7">Track 7</option>
                    <option value="8">Track 8</option>
                </select>
            </div>
            <br>
        </div>
        <form id="result-form">
            <div id="result-fields">
                <h3 style="margin-top:0;">Enter Result</h3>
            </div>
            <button type="submit" class="submit-btn">Submit Result</button>
        </form>
        <div id="result-message"></div>
    </main>

    <!-- supplementary JavaScript (for updating the selection field thing) -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const typeSelect = document.getElementById("type");
            const gradeSelect = document.getElementById("grade");
            const genderSelect = document.getElementById("gender");
            const itemsSelect = document.getElementById("items");
            const trackNoContainer = document.getElementById("track");
            const trackSelect = document.getElementById("track");

            const racingEvents = {
                A: ["100m", "200m", "400m", "800m", "1500m"],
                B: ["100m", "200m", "400m", "800m", "1500m"],
                C: ["60m", "100m", "200m", "400m", "800m", "1500m"]
            };

            const fieldEvents = {
                A: ["High Jump", "Javelin Throw", "Long Jump", "Shot Put"],
                B: ["High Jump", "Javelin Throw", "Long Jump", "Shot Put"],
                C: ["High Jump", "Long Jump", "Shot Put", "Softball"]
            };

            const relayEvents = ["4x100", "4x400", "8x100"];

            const mapGenderToDB = (formGender) => {
                if (formGender === 'male') return 'boys';
                if (formGender === 'female') return 'girls';
                return formGender;
            };

            const saveSelections = () => {
                localStorage.setItem('selectedType', typeSelect.value);
                localStorage.setItem('selectedGrade', gradeSelect.value);
                localStorage.setItem('selectedGender', genderSelect.value);
                localStorage.setItem('selectedItem', itemsSelect.value);
                if (trackNoContainer.style.display === 'block') {
                    localStorage.setItem('selectedTrack', trackSelect.value);
                } else {
                    localStorage.removeItem('selectedTrack');
                }
            };

            const loadSelections = () => {
                const storedType = localStorage.getItem('selectedType');
                const storedGrade = localStorage.getItem('selectedGrade');
                const storedGender = localStorage.getItem('selectedGender');
                const storedItem = localStorage.getItem('selectedItem');
                const storedTrack = localStorage.getItem('selectedTrack');

                if (storedType) typeSelect.value = storedType;
                if (storedGrade) gradeSelect.value = storedGrade;
                if (storedGender) genderSelect.value = storedGender;
                updateItemsDropdown(false);

                if (storedItem) itemsSelect.value = storedItem;
                const event = new Event('change');
                itemsSelect.dispatchEvent(event);

                if (storedTrack && trackNoContainer.style.display === 'block') {
                    trackSelect.value = storedTrack;
                }
            };

            const updateItemsDropdown = (shouldSave = true) => {
                const type = typeSelect.value;
                const grade = gradeSelect.value;
                const gender = genderSelect.value;
                itemsSelect.innerHTML = `<option value="" selected>--</option>`;
                trackNoContainer.style.display = "none";

                if (type && grade && gender) {
                    let events = [];
                    if (type === "racing") {
                        events = racingEvents[grade];
                    } else if (type === "field") {
                        events = fieldEvents[grade];
                    } else if (type === "relay") {
                        events = relayEvents;
                    }

                    events.forEach(event => {
                        const option = document.createElement("option");
                        option.value = event;
                        option.textContent = event;
                        itemsSelect.appendChild(option);
                    });
                }
                if (shouldSave) saveSelections();
                updateResultForm();
            };

            itemsSelect.addEventListener("change", () => {
                const selectedItem = itemsSelect.value;
                if (["100m", "200m", "400m"].includes(selectedItem)) {
                    trackNoContainer.style.display = "block";
                } else {
                    trackNoContainer.style.display = "none";
                }
                saveSelections();
                updateResultForm();
            });

            // listeners for dropdowns
            typeSelect.addEventListener("change", () => { updateItemsDropdown(); });
            gradeSelect.addEventListener("change", () => { updateItemsDropdown(); });
            genderSelect.addEventListener("change", () => { updateItemsDropdown(); });
            trackSelect.addEventListener("change", saveSelections);

            const resultForm = document.getElementById("result-form");
            const resultFields = document.getElementById("result-fields");
            const resultMessage = document.getElementById("result-message");
            const submitButton = resultForm.querySelector('.submit-btn');

            function updateResultForm() {
                const type = typeSelect.value;
                const grade = gradeSelect.value;
                const gender = genderSelect.value;
                const item = itemsSelect.value;
                if (type && grade && gender && item) {
                    renderResultFields(type, item);
                }
            }
            function renderResultFields(type, selectedItem = null) {
                let html = '<h3 style="margin-top:0;">Enter Result</h3>';
                if (type === "racing") {
                    html += `
                        <div>
                            <label>Heat/Final:</label>
                            <select name="types" required>
                                <option value="heat">Heat</option>
                                <option value="final">Final</option>
                            </select>
                        </div>
                        <div>
                            <label>Athlete ID:</label>
                            <input name="athlete_id" type="text" required>
                        </div>
                        <div>
                            <label>Time (s):</label>
                            <input name="time" type="text" inputmode="decimal" pattern="\\d+(\\.\\d+)?" placeholder="e.g. 12.34" required>
                        </div>
                    `;
                } else if (type === "field") {
                    html += `
                        <div>
                            <label>Heat/Final:</label>
                            <select name="types" required>
                                <option value="heat">Heat</option>
                                <option value="final">Final</option>
                            </select>
                        </div>
                        <div>
                            <label>Athlete ID:</label>
                            <input name="athlete_id" type="text" required>
                        </div>
                        <div>
                            <label>Trial:</label>
                            <input name="trial" type="number" min="1" required>
                        </div>
                        <div>
                            <label>Distance (m):</label>
                            <input name="distance" type="text" inputmode="decimal" pattern="\\d+(\\.\\d+)?" placeholder="e.g. 5.67" required>
                        </div>
                    `;
                } else if (type === "relay") {
                    let maxPosition = (selectedItem === "8x100") ? 8 : 4;
                    html += `
                        <div>
                            <label>Athlete ID:</label>
                            <input name="athlete_id" type="text" required>
                        </div>
                        <div>
                            <label>Position:</label>
                            <input name="position" type="number" min="1" max="${maxPosition}" required>
                        </div>
                        <div>
                            <label>Team:</label>
                            <input name="team" type="text" required>
                        </div>
                        <div>
                            <label>Time (s):</label>
                            <input name="time" type="text" inputmode="decimal" pattern="\\d+(\\.\\d+)?" placeholder="e.g. 48.76" required>
                        </div>
                    `;
                }
                resultFields.innerHTML = html;
            }

            loadSelections(); 
            updateResultForm();

            resultForm.addEventListener("submit", async function(e) {
                e.preventDefault();
                resultMessage.textContent = "";
                resultMessage.className = "";
                submitButton.disabled = true;

                const type = typeSelect.value;
                const grade = gradeSelect.value;
                const gender = genderSelect.value;
                const item = itemsSelect.value;

                if (!type || !grade || !gender || !item) {
                    resultMessage.textContent = "Please select all event details before submitting.";
                    resultMessage.classList.add("error");
                    submitButton.disabled = false;
                    submitButton.textContent = "Submit Result";
                    return;
                }
            });
        });
    </script>
</body>
</html>

